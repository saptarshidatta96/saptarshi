<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Serving Machine Learning Model With Api | Saptarshi Datta</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Serving Machine Learning Model With Api" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Till now, all the blogs I’ve posted were basically leveraging CNN pre-trained models to develop a model that was useful for our given use case. But from my experience at TCS Rapid Labs, I have learnt that training models is not enough. We not to serve them to make them usable across our production systems." />
<meta property="og:description" content="Till now, all the blogs I’ve posted were basically leveraging CNN pre-trained models to develop a model that was useful for our given use case. But from my experience at TCS Rapid Labs, I have learnt that training models is not enough. We not to serve them to make them usable across our production systems." />
<link rel="canonical" href="https://saptarshidatta.in/2021/12/14/serving-machine-learning-model-with-api.html" />
<meta property="og:url" content="https://saptarshidatta.in/2021/12/14/serving-machine-learning-model-with-api.html" />
<meta property="og:site_name" content="Saptarshi Datta" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-14T00:00:00-06:00" />
<script type="application/ld+json">
{"dateModified":"2021-12-14T00:00:00-06:00","datePublished":"2021-12-14T00:00:00-06:00","url":"https://saptarshidatta.in/2021/12/14/serving-machine-learning-model-with-api.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://saptarshidatta.in/2021/12/14/serving-machine-learning-model-with-api.html"},"headline":"Serving Machine Learning Model With Api","description":"Till now, all the blogs I’ve posted were basically leveraging CNN pre-trained models to develop a model that was useful for our given use case. But from my experience at TCS Rapid Labs, I have learnt that training models is not enough. We not to serve them to make them usable across our production systems.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://saptarshidatta.in/feed.xml" title="Saptarshi Datta" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link href="https://cdn.jsdelivr.net/npm/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.css">

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Saptarshi Datta</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/kb/">Knowledge Base</a><a class="page-link" href="/projects/">Projects</a><a class="page-link" href="/cv/">Curriculum Vitae</a><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Serving Machine Learning Model With Api</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-12-14T00:00:00-06:00" itemprop="datePublished">
        Dec 14, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Till now, all the blogs I’ve posted were basically leveraging CNN pre-trained models to develop a model that was useful for our given use case. But from my experience at TCS Rapid Labs, I have learnt that training models is not enough. We not to serve them to make them usable across our production systems.</p>

<p>Now, once we have acknowledged this gap in our learning journey, there is one more thing we need to take account of. Most of the production grade systems and legacy application who are willing to leavrage the power of AI are essentially not written in Python. However, most of us are using Python to train our models. This is where we can use power of APIs.</p>

<p>In this blog, we will be learning to wrap our ML Models into an API. We will be building a simple classifier whose job is to classify a breast tumour as malignant or benign based on the features in the dataset. After that we will be saving the trained model(Serialization &amp; Deserialization), exposing the functionality of the model as an API and testing the API using Postman. Additionally the entire setup is avialble as a Docker Image <a href="https://hub.docker.com/repository/docker/saptarshidatta96/breast_cancer">here</a> and code is availble <a href="https://github.com/saptarshidatta96/Breast-Cancer">here</a>.</p>

<p>The model training script is uploaded at the GitHub Repository above and will not be discussed here. However, we will discuss about serializing the model as pickle file, deserializing it and exposing the functionality of the model as a Flask API. We will be using sk-learn’s <code class="language-plaintext highlighter-rouge">joblib</code> library for this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">joblib</span>
<span class="n">joblib</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">'breast_cancer_knn_model.pkl'</span><span class="p">)</span>
<span class="n">model_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cancer_data</span><span class="p">[</span><span class="s">'feature_names'</span><span class="p">])</span>
<span class="n">joblib</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_columns</span><span class="p">,</span> <span class="s">'model_columns.pkl'</span><span class="p">)</span>
</code></pre></div></div>
<p>Here, the object <code class="language-plaintext highlighter-rouge">model</code> refers to our trained model and the <code class="language-plaintext highlighter-rouge">model_columns</code> contains the list of columns in the dataset. We will serialize both of these as .pkl file. The reason for serializing <code class="language-plaintext highlighter-rouge">model_columns</code> is explained below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from flask import Flask, request, jsonify
import joblib
import pandas as pd


app = Flask(__name__)

@app.route('/predict', methods=['GET'])


def predict():
    if knn_model:
        try:
            if request.get_json() is not None:
                json_ = request.json
                query = pd.get_dummies(pd.DataFrame(json_))
                query = query.reindex(columns=model_columns, fill_value=0)
                prediction = list(knn_model.predict(query))

                return jsonify({'prediction': str(prediction),
                                'Input': request.json})
            else:
                
                json_ = [request.args]
                query = pd.get_dummies(pd.DataFrame(json_))
                query = query.reindex(columns=model_columns, fill_value=0)
                prediction = list(knn_model.predict(query))

                return jsonify({'prediction': str(prediction),
                                'Input': [request.args]})

        except Exception as e:

            return jsonify({'error': e})
    else:
        print ('Train the model first')
        return ('No model here to use')

if __name__ == '__main__':

    knn_model = joblib.load("breast_cancer_knn_model.pkl")
    print ('Model loaded')
    model_columns = joblib.load("model_columns.pkl")
    print ('Model columns loaded')
    app.run(host='0.0.0.0', port=12345, debug=True)
</code></pre></div></div>
<p>The above script is responsible for exposing the functionality of out trained model as an API. We have deserialized the two .pkl files.Now, if noticed carefully the function that we wrote would only work under conditions where the incoming request contains all possible values for the categorical variables which may or may not be the case in real-time. If the incoming request does not include all possible values of the categorical variables then as per the current method definition of <code class="language-plaintext highlighter-rouge">predict()</code>, <code class="language-plaintext highlighter-rouge">get_dummies()</code> would generate a dataframe that has fewer columns than the classifier excepts, which would result in a runtime error. Hence we have serialized the columns of the dataset in .pkl format.</p>

<p>Now that we have written out script, we can test it using Postman to check whether it’s working correctly or not. Below is a typical input we will send to our API.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
    {
        "mean radius": 17.99,
        "mean texture": 10.38,
        "mean perimeter": 122.8,
        "mean area": 1001.0,
        "mean smoothness": 0.1184,
        "mean compactness": 0.2776,
        "mean concavity": 0.3001,
        "mean concave points": 0.1471,
        "mean symmetry": 0.2419,
        "mean fractal dimension": 0.07871,
        "radius error": 1.095,
        "texture error": 0.9053,
        "perimeter error": 8.589,
        "area error": 153.4,
        "smoothness error": 0.006399,
        "compactness error": 0.04904,
        "concavity error": 0.05373,
        "concave points error": 0.01587,
        "symmetry error": 0.03003,
        "fractal dimension error": 0.006193,
        "worst radius": 25.38,
        "worst texture": 17.33,
        "worst perimeter": 184.6,
        "worst area": 2019.0,
        "worst smoothness": 0.1622,
        "worst compactness": 0.6656,
        "worst concavity": 0.7119,
        "worst concave points": 0.2654,
        "worst symmetry": 0.4601,
        "worst fractal dimension": 0.1189
    }
]
</code></pre></div></div>
<p>and the response received from the API will be :
<img src="/images/api_call1.PNG" alt="" /></p>

<p>Next, we will test our API by calling it from our browser. As discussed, we need not send values of all the variables for our API to work correctly. The service will interally handle it and give the output response.
Hence, we will call the API by</p>

<p><code class="language-plaintext highlighter-rouge">http://localhost:12345/predict?mean_compactness=0.277&amp;worst%20perimeter=184.6</code></p>

<p>The response should be like:
<img src="/images/api_call.PNG" alt="" /></p>

<p>Now, that we have seen that the API is functioning properly, we will now contanerize ouR application using Docker. For this, you must have <a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a> installed in your respective systems. Once Docker has been installed, create two files named <code class="language-plaintext highlighter-rouge">Dockerfile</code> and <code class="language-plaintext highlighter-rouge">requirements.txt</code>. Both these files are present on the GitHub Repository for this blog. Now, that we have all the requuired files, we created the docker image and pushed it to Docker Hub after testing it.</p>

<p>This concluded the end of our blog. Next, we can create a dummy clent application that will use our API. We can also deploy our API on Cloud Platforms like Azure, GCP or AWS. I will eb writing a blog on the same in the near future :)</p>

<p>To know more about Docker, please go through the <a href="https://docs.docker.com/get-started/">Docker Documentation</a>.</p>

<p>The GitHub Repo is available <a href="https://github.com/saptarshidatta96/Breast-Cancer">here</a>.
The Docker Image is available <a href="https://hub.docker.com/repository/docker/saptarshidatta96/breast_cancer">here</a>.</p>

<p>References:</p>
<ol>
  <li>
    <p><a href="https://docs.docker.com/get-started/">https://docs.docker.com/get-started/</a></p>
  </li>
  <li>
    <p><a href="https://www.datacamp.com/community/tutorials/machine-learning-models-api-python">https://www.datacamp.com/community/tutorials/machine-learning-models-api-python</a></p>
  </li>
  <li>
    <p><a href="https://learning.postman.com/docs/getting-started/introduction/">https://learning.postman.com/docs/getting-started/introduction/</a></p>
  </li>
  <li>
    <p><a href="https://www.geeksforgeeks.org/exposing-ml-dl-models-as-rest-apis/">https://www.geeksforgeeks.org/exposing-ml-dl-models-as-rest-apis/</a></p>
  </li>
  <li>
    <p><a href="https://www.kdnuggets.com/2021/12/deployment-machine-learning-algorithm-live-production-environment.html">https://www.kdnuggets.com/2021/12/deployment-machine-learning-algorithm-live-production-environment.html</a></p>
  </li>
</ol>

  </div><a class="u-url" href="/2021/12/14/serving-machine-learning-model-with-api.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Deep Learning, Computer Vision &amp; more.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/saptarshidatta96" title="saptarshidatta96"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ds_saptarshi" title="ds_saptarshi"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
